<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.bolife.blogspringboot.mapper.ArticleMapper">
    <resultMap id="BaseResultMap" type="com.bolife.blogspringboot.entity.Article">
        <id column="article_id" property="articleId" jdbcType="INTEGER"/>
        <result column="article_user_id" property="articleUserId" jdbcType="INTEGER"/>
        <result column="article_title" property="articleTitle" jdbcType="VARCHAR"/>
        <result column="article_content" property="articleContent" jdbcType="LONGVARCHAR"/>
        <result column="article_summary" property="articleSummary" jdbcType="VARCHAR"/>
        <result column="article_view_count" property="articleViewCount" jdbcType="INTEGER"/>
        <result column="article_comment_count" property="articleCommentCount" jdbcType="INTEGER"/>
        <result column="article_like_count" property="articleLikeCount" jdbcType="INTEGER"/>
        <result column="article_is_comment" property="articleIsComment" jdbcType="INTEGER"/>
        <result column="article_order" property="articleOrder" jdbcType="INTEGER"/>
        <result column="article_create_time" property="articleCreateTime" jdbcType="TIMESTAMP"/>
        <result column="article_update_time" property="articleUpdateTime" jdbcType="TIMESTAMP"/>
        <result column="article_status" property="articleStatus" jdbcType="INTEGER"/>
    </resultMap>
    <select id="findAllArticle" resultMap="BaseResultMap">
        SELECT * FROM article WHERE article_status = 1
        <if test="categoryId != null">
            and article.article_id IN (
            SELECT article_category_ref.article_id FROM article_category_ref
            WHERE article_category_ref.category_id = #{categoryId}
            )
        </if>
        <if test="tagId != null">
            and article.article_id IN (
            SELECT article_tag_ref.article_id FROM article_tag_ref
            WHERE article_tag_ref.tag_id = #{tagId}
            )
        </if>
        <if test="keywords != null">
            and article.article_title LIKE concat(concat('%',#{keywords}),'%')
        </if>
        ORDER BY article_update_time DESC
    </select>

    <select id="findArticleCount" resultType="Integer">
        SELECT count(*) FROM article WHERE article_status=1
    </select>

    <select id="findArticleByCommentCount" resultMap="BaseResultMap">
        SELECT * FROM article ORDER BY article_comment_count DESC Limit #{count}
    </select>

    <select id="findRandomArticle" resultMap="BaseResultMap">
        SELECT * FROM article WHERE article_status = 1 ORDER BY RAND() limit #{limit}
    </select>

    <select id="findArticleById" resultMap="BaseResultMap">
        SELECT * FROM article WHERE article_id=#{aid}
    </select>
    <select id="findArticleByCategories" resultMap="BaseResultMap">
        SELECT article.* FROM article,article_category_ref
        <where>
            article.article_status = 1 AND
            article.article_id = article_category_ref.article_id AND
            article_category_ref.category_id
            <if test="categoryIds != null">
                IN
                <foreach collection="categoryIds" open="(" close=")" separator="," item="id">
                    #{id.categoryId}
                </foreach>
            </if>
        </where>
        limit #{limit}
    </select>

    <select id="findArticleByViewCount" resultMap="BaseResultMap">
        SELECT * FROM article WHERE article_status = 1 ORDER BY article_view_count DESC limit #{limit}
    </select>

    <select id="findAfterArticle" resultMap="BaseResultMap">
        SELECT * FROM article WHERE article_status = 1 AND article_id >#{aid} ORDER BY article_id limit 1
    </select>

    <select id="findBeforeArticle" resultMap="BaseResultMap">
        SELECT * FROM article WHERE article_status = 1 AND article_id >#{aid} ORDER BY article_id limit 1
    </select>

    <select id="getArticleViewCount" resultType="Integer">
        SELECT SUM(article_view_count) FROM
        article
        WHERE article_status = 1
    </select>

    <update id="updateArticle" parameterType="com.bolife.blogspringboot.entity.Article">
        UPDATE article
        <set>
            <if test="articleUserId != null">article_user_id = #{articleUserId,jdbcType=INTEGER},</if>
            <if test="articleTitle != null">article_title = #{articleTitle,jdbcType=VARCHAR},</if>
            <if test="articleViewCount != null">article_view_count = #{articleViewCount,jdbcType=INTEGER},</if>
            <if test="articleCommentCount != null">article_comment_count = #{articleCommentCount,jdbcType=INTEGER},</if>
            <if test="articleLikeCount != null">article_like_count = #{articleLikeCount,jdbcType=INTEGER},</if>
            <if test="articleCreateTime != null">article_create_time = #{articleCreateTime,jdbcType=TIMESTAMP},</if>
            <if test="articleUpdateTime != null">article_update_time = #{articleUpdateTime,jdbcType=TIMESTAMP},</if>
            <if test="articleIsComment != null">article_is_comment = #{articleIsComment,jdbcType=INTEGER},</if>
            <if test="articleStatus != null">article_status = #{articleStatus,jdbcType=INTEGER},</if>
            <if test="articleOrder != null">article_order = #{articleOrder,jdbcType=INTEGER},</if>
            <if test="articleContent != null">article_content = #{articleContent,jdbcType=LONGVARCHAR},</if>
            <if test="articleSummary != null">article_summary = #{articleSummary,jdbcType=VARCHAR},</if>
        </set>
        where article_id = #{articleId,jdbcType=INTEGER}
    </update>
</mapper>